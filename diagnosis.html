<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŸºé‡‘åˆ†æå·¥å…· - è¯Šæ–­æŠ¥å‘Š</title>
    <style>
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .diagnostic-section {
        background: rgba(30, 41, 59, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .status {
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
      }
      .status.success {
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid #10b981;
        color: #10b981;
      }
      .status.error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid #ef4444;
        color: #ef4444;
      }
      .status.warning {
        background: rgba(245, 158, 11, 0.2);
        border: 1px solid #f59e0b;
        color: #f59e0b;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .info-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #00d4aa;
      }
      .chart-test {
        height: 300px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        margin: 20px 0;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button {
        background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
      }
      .log-output {
        background: rgba(0, 0, 0, 0.5);
        color: #00ff00;
        font-family: 'Courier New', monospace;
        padding: 15px;
        border-radius: 6px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 12px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” åŸºé‡‘åˆ†æå·¥å…· - è¯Šæ–­æŠ¥å‘Š</h1>

      <div class="diagnostic-section">
        <h2>ğŸ“Š ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥</h2>
        <div id="env-check"></div>
      </div>

      <div class="diagnostic-section">
        <h2>ğŸ¯ æ”¶ç›Šè¶‹åŠ¿å›¾è¯Šæ–­</h2>
        <div id="chart-diagnosis"></div>
        <div id="chart-test-container" class="chart-test">
          <span style="color: rgba(255, 255, 255, 0.5)">å›¾è¡¨æµ‹è¯•åŒºåŸŸ</span>
        </div>
        <button onclick="runChartTest()">è¿è¡Œå›¾è¡¨æµ‹è¯•</button>
      </div>

      <div class="diagnostic-section">
        <h2>ğŸ”§ JavaScripté”™è¯¯æ£€æŸ¥</h2>
        <div id="js-errors"></div>
      </div>

      <div class="diagnostic-section">
        <h2>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
        <div id="debug-log" class="log-output"></div>
      </div>

      <div class="diagnostic-section">
        <h2>ğŸ› ï¸ ä¿®å¤å»ºè®®</h2>
        <div id="fix-suggestions"></div>
      </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="resources/echarts.min.js"></script>

    <script>
      let errorLog = [];
      let debugMessages = [];

      // é‡å†™consoleæ–¹æ³•ä»¥æ•è·æ—¥å¿—
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
      };

      console.log = function (...args) {
        debugMessages.push({ type: 'log', message: args.join(' '), timestamp: new Date().toLocaleTimeString() });
        originalConsole.log.apply(console, args);
      };

      console.error = function (...args) {
        errorLog.push({ type: 'error', message: args.join(' '), timestamp: new Date().toLocaleTimeString() });
        debugMessages.push({ type: 'error', message: args.join(' '), timestamp: new Date().toLocaleTimeString() });
        originalConsole.error.apply(console, args);
      };

      console.warn = function (...args) {
        debugMessages.push({ type: 'warn', message: args.join(' '), timestamp: new Date().toLocaleTimeString() });
        originalConsole.warn.apply(console, args);
      };

      function addDebugMessage(message, type = 'info') {
        debugMessages.push({ type, message, timestamp: new Date().toLocaleTimeString() });
        updateDebugLog();
      }

      function updateDebugLog() {
        const logDiv = document.getElementById('debug-log');
        logDiv.innerHTML = debugMessages
          .map(
            (msg) =>
              `<div style="color: ${msg.type === 'error' ? '#ef4444' : msg.type === 'warn' ? '#f59e0b' : '#10b981'};">
                    [${msg.timestamp}] ${msg.message}
                </div>`
          )
          .join('');
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function runEnvironmentCheck() {
        addDebugMessage('å¼€å§‹ç¯å¢ƒæ£€æŸ¥...');

        const envDiv = document.getElementById('env-check');
        const checks = [];

        // æ£€æŸ¥æµè§ˆå™¨
        checks.push({
          name: 'æµè§ˆå™¨',
          status: 'success',
          message: `${navigator.userAgent}`,
        });

        // æ£€æŸ¥ECharts
        checks.push({
          name: 'EChartsåº“',
          status: typeof echarts !== 'undefined' ? 'success' : 'error',
          message: typeof echarts !== 'undefined' ? `å·²åŠ è½½ (ç‰ˆæœ¬: ${echarts.version})` : 'æœªåŠ è½½',
        });

        // æ£€æŸ¥DOMçŠ¶æ€
        checks.push({
          name: 'DOMçŠ¶æ€',
          status: document.readyState === 'complete' ? 'success' : 'warning',
          message: `æ–‡æ¡£çŠ¶æ€: ${document.readyState}`,
        });

        // æ£€æŸ¥å±å¹•å°ºå¯¸
        checks.push({
          name: 'å±å¹•å°ºå¯¸',
          status: 'success',
          message: `${window.innerWidth}x${window.innerHeight}`,
        });

        envDiv.innerHTML = checks
          .map(
            (check) => `
                <div class="info-item">
                    <strong>${check.name}:</strong> 
                    <span class="status ${check.status}">${check.message}</span>
                </div>
            `
          )
          .join('');

        addDebugMessage('ç¯å¢ƒæ£€æŸ¥å®Œæˆ');
      }

      function runChartDiagnosis() {
        addDebugMessage('å¼€å§‹æ”¶ç›Šè¶‹åŠ¿å›¾è¯Šæ–­...');

        const diagnosisDiv = document.getElementById('chart-diagnosis');
        const diagnoses = [];

        // æ£€æŸ¥ä¸»é¡µé¢ä¸­çš„å…ƒç´ 
        const mainChartDiv = document.getElementById('profit-trend-chart');
        diagnoses.push({
          name: 'å½“å‰é¡µé¢å›¾è¡¨DIV',
          status: mainChartDiv ? 'success' : 'error',
          message: mainChartDiv
            ? `æ‰¾åˆ°å…ƒç´  (å°ºå¯¸: ${mainChartDiv.offsetWidth}x${mainChartDiv.offsetHeight})`
            : 'æœªæ‰¾åˆ°profit-trend-chartå…ƒç´ ',
        });

        // æ£€æŸ¥æ˜¯å¦æœ‰æ ·å¼é—®é¢˜
        if (mainChartDiv) {
          const computedStyle = window.getComputedStyle(mainChartDiv);
          diagnoses.push({
            name: 'å…ƒç´ å¯è§æ€§',
            status: computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden' ? 'success' : 'error',
            message: `display: ${computedStyle.display}, visibility: ${computedStyle.visibility}`,
          });

          diagnoses.push({
            name: 'å…ƒç´ å°ºå¯¸',
            status: mainChartDiv.offsetHeight > 0 && mainChartDiv.offsetWidth > 0 ? 'success' : 'warning',
            message: `å®½åº¦: ${mainChartDiv.offsetWidth}px, é«˜åº¦: ${mainChartDiv.offsetHeight}px`,
          });
        }

        diagnosisDiv.innerHTML = diagnoses
          .map(
            (diagnosis) => `
                <div class="info-item">
                    <strong>${diagnosis.name}:</strong> 
                    <span class="status ${diagnosis.status}">${diagnosis.message}</span>
                </div>
            `
          )
          .join('');

        addDebugMessage('å›¾è¡¨è¯Šæ–­å®Œæˆ');
      }

      function runChartTest() {
        addDebugMessage('å¼€å§‹å›¾è¡¨æµ‹è¯•...');

        const container = document.getElementById('chart-test-container');
        container.innerHTML = '<span style="color: rgba(255,255,255,0.5);">æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨...</span>';

        try {
          // åˆ›å»ºæ–°çš„divç”¨äºæµ‹è¯•
          const testDiv = document.createElement('div');
          testDiv.id = 'test-chart';
          testDiv.style.height = '100%';
          testDiv.style.width = '100%';
          container.innerHTML = '';
          container.appendChild(testDiv);

          // åˆå§‹åŒ–å›¾è¡¨
          const chart = echarts.init(testDiv);
          addDebugMessage('å›¾è¡¨å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');

          // ç”Ÿæˆæµ‹è¯•æ•°æ®
          const dates = [];
          const values = [];
          for (let i = 30; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('zh-CN'));
            values.push(Math.random() * 1000 + 500);
          }

          // è®¾ç½®é€‰é¡¹
          const option = {
            backgroundColor: 'transparent',
            title: {
              text: 'æµ‹è¯•æ”¶ç›Šè¶‹åŠ¿',
              textStyle: { color: '#fff' },
            },
            tooltip: {
              trigger: 'axis',
              backgroundColor: 'rgba(0,0,0,0.8)',
              textStyle: { color: '#fff' },
            },
            xAxis: {
              type: 'category',
              data: dates,
              axisLabel: { color: '#8892b0' },
            },
            yAxis: {
              type: 'value',
              axisLabel: { color: '#8892b0' },
            },
            series: [
              {
                data: values,
                type: 'line',
                smooth: true,
                lineStyle: { color: '#00d4aa', width: 3 },
                areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(0, 212, 170, 0.3)' },
                    { offset: 1, color: 'rgba(0, 212, 170, 0.05)' },
                  ]),
                },
              },
            ],
          };

          chart.setOption(option);
          addDebugMessage('å›¾è¡¨é€‰é¡¹è®¾ç½®æˆåŠŸ', 'success');

          // æ·»åŠ å“åº”å¼
          window.addEventListener('resize', () => chart.resize());

          addDebugMessage('å›¾è¡¨æµ‹è¯•å®Œæˆ', 'success');
        } catch (error) {
          addDebugMessage(`å›¾è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          container.innerHTML = `<span style="color: #ef4444;">å›¾è¡¨æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
        }
      }

      function generateFixSuggestions() {
        const suggestions = [];

        // åŸºäºè¯Šæ–­ç»“æœç”Ÿæˆå»ºè®®
        if (typeof echarts === 'undefined') {
          suggestions.push({
            priority: 'é«˜',
            issue: 'EChartsåº“æœªåŠ è½½',
            solution: 'ç¡®ä¿åœ¨HTMLä¸­æ­£ç¡®å¼•å…¥EChartsåº“ï¼š<br><code>&lt;script src=\"resources/echarts.min.js\"&gt;&lt;/script&gt;</code>',
          });
        }

        const mainChartDiv = document.getElementById('profit-trend-chart');
        if (!mainChartDiv) {
          suggestions.push({
            priority: 'é«˜',
            issue: 'å›¾è¡¨DIVå…ƒç´ ä¸å­˜åœ¨',
            solution: 'ç¡®ä¿HTMLä¸­å­˜åœ¨IDä¸º"profit-trend-chart"çš„DIVå…ƒç´ ',
          });
        } else if (mainChartDiv.offsetHeight === 0 || mainChartDiv.offsetWidth === 0) {
          suggestions.push({
            priority: 'é«˜',
            issue: 'å›¾è¡¨å…ƒç´ å°ºå¯¸ä¸º0',
            solution: 'æ£€æŸ¥CSSæ ·å¼ï¼Œç¡®ä¿å…ƒç´ æœ‰æ˜ç¡®çš„å®½åº¦å’Œé«˜åº¦ã€‚å¯ä»¥å°è¯•è®¾ç½®ï¼š<br><code>style="height: 400px; width: 100%;"</code>',
          });
        }

        suggestions.push({
          priority: 'ä¸­',
          issue: 'åˆå§‹åŒ–æ—¶æœºé—®é¢˜',
          solution:
            'ç¡®ä¿å›¾è¡¨åˆå§‹åŒ–ä»£ç åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œã€‚ä½¿ç”¨ï¼š<br><code>document.addEventListener("DOMContentLoaded", function() { /* åˆå§‹åŒ–ä»£ç  */ });</code>',
        });

        suggestions.push({
          priority: 'ä¸­',
          issue: 'æ•°æ®åŠ è½½é—®é¢˜',
          solution: 'æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ‹Ÿæ•°æ®æˆ–å®é™…æ•°æ®è¢«æ­£ç¡®åŠ è½½åˆ°å›¾è¡¨ä¸­ã€‚åœ¨main.jsä¸­æŸ¥çœ‹initProfitTrendChartå‡½æ•°çš„å®ç°',
        });

        const suggestionsDiv = document.getElementById('fix-suggestions');
        suggestionsDiv.innerHTML = suggestions
          .map(
            (suggestion) => `
                <div class="info-item" style="border-left-color: ${suggestion.priority === 'é«˜' ? '#ef4444' : '#f59e0b'};">
                    <strong>ä¼˜å…ˆçº§: ${suggestion.priority}</strong><br>
                    <strong>é—®é¢˜:</strong> ${suggestion.issue}<br>
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong> ${suggestion.solution}
                </div>
            `
          )
          .join('');
      }

      // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæ‰€æœ‰æ£€æŸ¥
      window.addEventListener('DOMContentLoaded', () => {
        addDebugMessage('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');

        setTimeout(() => {
          runEnvironmentCheck();
          runChartDiagnosis();
          generateFixSuggestions();
          addDebugMessage('æ‰€æœ‰è¯Šæ–­å®Œæˆ');
        }, 500);
      });

      // æ•è·å…¨å±€é”™è¯¯
      window.addEventListener('error', (event) => {
        errorLog.push({
          type: 'global_error',
          message: `${event.message} at ${event.filename}:${event.lineno}:${event.colno}`,
          timestamp: new Date().toLocaleTimeString(),
        });

        const errorDiv = document.getElementById('js-errors');
        errorDiv.innerHTML = `
                <div class="info-item" style="border-left-color: #ef4444;">
                    <strong>æ•è·åˆ°JavaScripté”™è¯¯:</strong><br>
                    ${event.message}<br>
                    <small>ä½ç½®: ${event.filename}:${event.lineno}:${event.colno}</small>
                </div>
            `;

        addDebugMessage(`å…¨å±€é”™è¯¯æ•è·: ${event.message}`, 'error');
      });
    </script>
  </body>
</html>
