<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸»é¡µé¢çŠ¶æ€æ£€æŸ¥</title>
    <style>
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .check-section {
        background: rgba(30, 41, 59, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .status {
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
      }
      .status.success {
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid #10b981;
        color: #10b981;
      }
      .status.error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid #ef4444;
        color: #ef4444;
      }
      .status.info {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid #3b82f6;
        color: #3b82f6;
      }
      button {
        background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 10px 5px;
        transition: all 0.3s ease;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
      }
      iframe {
        width: 100%;
        height: 600px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        background: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ  ä¸»é¡µé¢çŠ¶æ€æ£€æŸ¥</h1>

      <div class="check-section">
        <h2>ğŸ“Š æ£€æŸ¥é€‰é¡¹</h2>
        <button onclick="loadMainPage()">åŠ è½½ä¸»é¡µé¢</button>
        <button onclick="checkConsoleErrors()">æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</button>
        <button onclick="checkChartElements()">æ£€æŸ¥å›¾è¡¨å…ƒç´ </button>
        <button onclick="testChartFunction()">æµ‹è¯•å›¾è¡¨å‡½æ•°</button>
      </div>

      <div class="check-section">
        <h2>ğŸ–¼ï¸ ä¸»é¡µé¢é¢„è§ˆ</h2>
        <div id="status-info" class="status info">ç‚¹å‡»"åŠ è½½ä¸»é¡µé¢"å¼€å§‹æ£€æŸ¥</div>
        <iframe id="main-page-frame" style="display: none"></iframe>
      </div>

      <div class="check-section">
        <h2>ğŸ¯ å›¾è¡¨å…ƒç´ æ£€æŸ¥</h2>
        <div id="element-check"></div>
      </div>

      <div class="check-section">
        <h2>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h2>
        <div
          id="console-log"
          style="
            background: rgba(0, 0, 0, 0.5);
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
          "
        ></div>
      </div>
    </div>

    <script>
      let consoleMessages = [];
      let iframeWindow = null;

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        consoleMessages.push({ timestamp, message, type });
        updateConsoleLog();
        console.log(`[${timestamp}] ${message}`);
      }

      function updateConsoleLog() {
        const logDiv = document.getElementById('console-log');
        logDiv.innerHTML = consoleMessages
          .map(
            (msg) =>
              `<div style="color: ${msg.type === 'error' ? '#ef4444' : msg.type === 'success' ? '#10b981' : '#f59e0b'};">
                    [${msg.timestamp}] ${msg.message}
                </div>`
          )
          .join('');
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status-info');
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;
      }

      function loadMainPage() {
        log('å¼€å§‹åŠ è½½ä¸»é¡µé¢...');
        updateStatus('æ­£åœ¨åŠ è½½ä¸»é¡µé¢...', 'info');

        const iframe = document.getElementById('main-page-frame');
        iframe.style.display = 'block';
        iframe.src = '/index.html';

        iframe.onload = () => {
          log('ä¸»é¡µé¢åŠ è½½æˆåŠŸ', 'success');
          updateStatus('ä¸»é¡µé¢åŠ è½½å®Œæˆ', 'success');

          try {
            iframeWindow = iframe.contentWindow;

            // æ•è·iframeä¸­çš„æ§åˆ¶å°æ¶ˆæ¯
            if (iframeWindow.console) {
              const originalLog = iframeWindow.console.log;
              const originalError = iframeWindow.console.error;

              iframeWindow.console.log = function (...args) {
                log(`[ä¸»é¡µé¢] ${args.join(' ')}`, 'info');
                originalLog.apply(iframeWindow.console, args);
              };

              iframeWindow.console.error = function (...args) {
                log(`[ä¸»é¡µé¢é”™è¯¯] ${args.join(' ')}`, 'error');
                originalError.apply(iframeWindow.console, args);
              };
            }
          } catch (error) {
            log(`æ— æ³•è®¿é—®iframeå†…å®¹: ${error.message}`, 'error');
          }
        };

        iframe.onerror = () => {
          log('ä¸»é¡µé¢åŠ è½½å¤±è´¥', 'error');
          updateStatus('ä¸»é¡µé¢åŠ è½½å¤±è´¥', 'error');
        };
      }

      function checkConsoleErrors() {
        log('æ£€æŸ¥æ§åˆ¶å°é”™è¯¯...');

        if (!iframeWindow) {
          log('è¯·å…ˆåŠ è½½ä¸»é¡µé¢', 'error');
          return;
        }

        try {
          // æ£€æŸ¥å…¨å±€é”™è¯¯
          const originalOnError = iframeWindow.onerror;
          iframeWindow.onerror = function (msg, url, line, col, error) {
            log(`å…¨å±€é”™è¯¯: ${msg} at ${url}:${line}:${col}`, 'error');
            if (originalOnError) originalOnError.apply(this, arguments);
            return true;
          };

          log('é”™è¯¯ç›‘å¬å™¨å·²è®¾ç½®', 'success');
        } catch (error) {
          log(`æ£€æŸ¥æ§åˆ¶å°é”™è¯¯å¤±è´¥: ${error.message}`, 'error');
        }
      }

      function checkChartElements() {
        log('æ£€æŸ¥å›¾è¡¨å…ƒç´ ...');

        if (!iframeWindow) {
          log('è¯·å…ˆåŠ è½½ä¸»é¡µé¢', 'error');
          return;
        }

        try {
          const iframeDoc = iframeWindow.document;
          const results = [];

          // æ£€æŸ¥æ”¶ç›Šè¶‹åŠ¿å›¾å…ƒç´ 
          const profitChart = iframeDoc.getElementById('profit-trend-chart');
          results.push({
            name: 'æ”¶ç›Šè¶‹åŠ¿å›¾DIV',
            found: !!profitChart,
            details: profitChart ? `å°ºå¯¸: ${profitChart.offsetWidth}x${profitChart.offsetHeight}px` : 'æœªæ‰¾åˆ°',
          });

          // æ£€æŸ¥å…¶ä»–å›¾è¡¨å…ƒç´ 
          const chartIds = ['asset-allocation-chart', 'industry-chart', 'profit-trend-chart'];
          chartIds.forEach((id) => {
            const element = iframeDoc.getElementById(id);
            results.push({
              name: `${id}`,
              found: !!element,
              details: element ? `å°ºå¯¸: ${element.offsetWidth}x${element.offsetHeight}px` : 'æœªæ‰¾åˆ°',
            });
          });

          // æ˜¾ç¤ºç»“æœ
          const elementDiv = document.getElementById('element-check');
          elementDiv.innerHTML = results
            .map(
              (result) => `
                    <div style="margin: 10px 0; padding: 10px; background: ${result.found ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 6px; border-left: 4px solid ${result.found ? '#10b981' : '#ef4444'};">
                        <strong>${result.name}:</strong> 
                        <span style="color: ${result.found ? '#10b981' : '#ef4444'};">
                            ${result.found ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}
                        </span><br>
                        <small>${result.details}</small>
                    </div>
                `
            )
            .join('');

          log('å›¾è¡¨å…ƒç´ æ£€æŸ¥å®Œæˆ', 'success');
        } catch (error) {
          log(`æ£€æŸ¥å›¾è¡¨å…ƒç´ å¤±è´¥: ${error.message}`, 'error');
        }
      }

      function testChartFunction() {
        log('æµ‹è¯•å›¾è¡¨å‡½æ•°...');

        if (!iframeWindow) {
          log('è¯·å…ˆåŠ è½½ä¸»é¡µé¢', 'error');
          return;
        }

        try {
          // æ£€æŸ¥ä¸»è¦å‡½æ•°æ˜¯å¦å­˜åœ¨
          const functions = ['initCharts', 'initProfitTrendChart', 'updateDashboard'];
          const results = [];

          functions.forEach((funcName) => {
            const exists = typeof iframeWindow[funcName] === 'function';
            results.push({
              name: funcName,
              exists: exists,
              type: exists ? typeof iframeWindow[funcName] : 'undefined',
            });
          });

          // æ˜¾ç¤ºç»“æœ
          results.forEach((result) => {
            log(`å‡½æ•° ${result.name}: ${result.exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`, result.exists ? 'success' : 'error');
          });

          // å°è¯•è°ƒç”¨initChartså‡½æ•°
          if (iframeWindow.initCharts) {
            log('æ­£åœ¨å°è¯•è°ƒç”¨initChartså‡½æ•°...', 'info');
            iframeWindow.initCharts();
            log('initChartså‡½æ•°è°ƒç”¨å®Œæˆ', 'success');
          } else {
            log('initChartså‡½æ•°ä¸å­˜åœ¨', 'error');
          }
        } catch (error) {
          log(`æµ‹è¯•å›¾è¡¨å‡½æ•°å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      window.addEventListener('DOMContentLoaded', () => {
        log('çŠ¶æ€æ£€æŸ¥é¡µé¢åŠ è½½å®Œæˆ', 'success');
      });
    </script>
  </body>
</html>
